<mat-toolbar class="header-navbar" color="primary">
  <div class="navbar-container container-app">
    <!-- Логотип и название -->
    <div class="logo-section">
      <a routerLink="/home" class="logo-link">
        <logo-ui class="header-logo" [size]="36" variant="inverted"></logo-ui>
        <span class="site-name">AlwaysMarket</span>
      </a>
    </div>

    <!-- Центральное меню -->
    <div class="center-section">
      <nav class="nav-menu">
        <button mat-button routerLink="/home" routerLinkActive="active" class="nav-button">
          <mat-icon>home</mat-icon>
          <span class="nav-text">Главная</span>
        </button>
        <button mat-button routerLink="/products" routerLinkActive="active" class="nav-button">
          <mat-icon>shopping_bag</mat-icon>
          <span class="nav-text">Товары</span>
        </button>

        <!-- Кнопка "Пользователи" видна только админам -->
        <button
          *ngIf="(userRole$ | async) === 'admin'"
          mat-button
          routerLink="/users"
          routerLinkActive="active"
          class="nav-button"
        >
          <mat-icon>people</mat-icon>
          <span class="nav-text">Пользователи</span>
        </button>

        <!-- Кнопка "Dashboard" видна только админам -->
        <button
          *ngIf="(userRole$ | async) === 'admin'"
          mat-button
          routerLink="/dashboard"
          routerLinkActive="active"
          class="nav-button"
        >
          <mat-icon>dashboard</mat-icon>
          <span class="nav-text">Dashboard</span>
        </button>
      </nav>
    </div>

    <!-- Правая часть: поиск, корзина, тема, пользователь -->
    <div class="right-section">
      <!-- Поиск -->
      <div class="search-wrapper">
        <header-search-ui (search)="onSearch($event)" class="header-search"></header-search-ui>
      </div>

      <!-- Иконка корзины -->
      <button
        mat-icon-button
        class="cart-button"
        (click)="goToCart()"
        [matBadge]="cartItemsCount"
        matBadgeColor="accent"
        matBadgeSize="small"
        matTooltip="Корзина"
      >
        <mat-icon>shopping_cart</mat-icon>
      </button>

      <!-- Переключение темы -->
      <theme-toggle-ui class="theme-toggle"></theme-toggle-ui>

      <!-- Блок пользователя -->
      <div class="user-section">
        <ng-container *ngIf="isLoggedIn$ | async; else showLoginForm">
          <div class="user-info">
            <!-- Десктоп: текст + иконка -->
            <div class="desktop-user">
              <ng-container *ngIf="userEmail$ | async as userEmail">
                <span class="username-text">
                  Привет, {{ userEmail.split('@')[0] }}!
                </span>
              </ng-container>
              <button
                mat-icon-button
                class="user-button"
                [matMenuTriggerFor]="userMenu"
                matTooltip="Меню пользователя"
              >
                <mat-icon class="user-icon">account_circle</mat-icon>
              </button>
            </div>

            <!-- Мобильный: только иконка -->
            <div class="mobile-user">
              <button
                mat-icon-button
                class="user-button"
                [matMenuTriggerFor]="userMenu"
                matTooltip="Меню пользователя"
              >
                <mat-icon class="user-icon">account_circle</mat-icon>
              </button>
            </div>

            <!-- Кнопка выхода (только для десктопа) -->
            <button
              class="logout-button desktop-only"
              mat-icon-button
              type="button"
              aria-label="Logout"
              (click)="onLogout()"
              matTooltip="Выйти"
            >
              <mat-icon>logout</mat-icon>
            </button>
          </div>
        </ng-container>

        <ng-template #showLoginForm>
          <form class="login-form" [formGroup]="form" (ngSubmit)="onSubmit()">
            <div class="form-fields">
              <mat-form-field class="login-form-field" appearance="outline">
                <mat-label>Email</mat-label>
                <input
                  matInput
                  placeholder="Введите email"
                  formControlName="email"
                  type="email"
                  aria-label="Email"
                  class="form-input"
                />
              </mat-form-field>

              <mat-form-field class="login-form-field" appearance="outline">
                <mat-label>Пароль</mat-label>
                <input
                  matInput
                  placeholder="Введите пароль"
                  formControlName="password"
                  type="password"
                  aria-label="Password"
                  class="form-input"
                />
              </mat-form-field>
            </div>

            <button
              class="login-button"
              mat-raised-button
              type="submit"
              aria-label="Login"
              [disabled]="!form.valid"
            >
              <mat-icon>login</mat-icon>
              <span class="login-text">Войти</span>
            </button>
          </form>
        </ng-template>
      </div>
    </div>
  </div>
</mat-toolbar>

<!-- Меню пользователя -->
<mat-menu #userMenu="matMenu" class="user-menu" xPosition="before">
  <div class="user-menu-header">
    <div class="user-greeting">
      <mat-icon>account_circle</mat-icon>
      <div class="user-info-text">
        <span class="user-email">{{ (userEmail$ | async) || 'Пользователь' }}</span>
        <span class="user-role">{{ (userRole$ | async) || 'Пользователь' | titlecase }}</span>
      </div>
    </div>
  </div>

  <mat-divider></mat-divider>

  <button mat-menu-item routerLink="/profile" (click)="userMenu.closed.emit()">
    <mat-icon>person</mat-icon>
    <span>Профиль</span>
  </button>

  <button mat-menu-item (click)="goToCart(); userMenu.closed.emit()">
    <mat-icon>shopping_cart</mat-icon>
    <span>Моя корзина</span>
    <span class="cart-menu-count" *ngIf="cartItemsCount > 0">{{ cartItemsCount }}</span>
  </button>

  <button mat-menu-item routerLink="/orders" (click)="userMenu.closed.emit()">
    <mat-icon>shopping_bag</mat-icon>
    <span>Мои заказы</span>
  </button>

  <button mat-menu-item routerLink="/settings" (click)="userMenu.closed.emit()">
    <mat-icon>settings</mat-icon>
    <span>Настройки</span>
  </button>

  <mat-divider></mat-divider>

  <button mat-menu-item (click)="onLogout(); userMenu.closed.emit()">
    <mat-icon>logout</mat-icon>
    <span>Выйти</span>
  </button>
</mat-menu>

<!-- Логи доступа (можно скрыть или убрать) -->
<div class="access-logs" *ngIf="showLogs">
  <h3>Recent Access Attempts</h3>
  <div class="log-entry" *ngFor="let log of logService.getLogs()">
    <span class="timestamp">{{ log.timestamp | date:'medium' }}</span>
    <span class="user" [class.guest]="log.email === 'Guest'">
      {{ log.email }}
    </span>
    <span class="role">({{ log.userRole }})</span>
    <span class="url">attempted to access: {{ log.targetUrl }}</span>
  </div>
</div>
